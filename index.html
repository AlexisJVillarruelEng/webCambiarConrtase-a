<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Cambiar contrase침a</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        max-width: 480px;
        margin: 40px auto;
        padding: 16px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
      }
      input {
        width: 100%;
        padding: 8px;
        margin-bottom: 16px;
      }
      button {
        padding: 10px 16px;
        cursor: pointer;
      }
      #status {
        margin-bottom: 12px;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Cambiar contrase침a</h1>
      <p id="status">Verificando enlace...</p>

      <form id="password-form" style="display:none;">
        <label for="password">Nueva contrase침a</label>
        <input type="password" id="password" minlength="6" required />

        <button type="submit">Guardar contrase침a</button>
      </form>
    </div>

    <!-- Supabase JS v2 desde CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      const { createClient } = supabase;

      // 游녢 PON AQU칈 TUS DATOS REALES
      const SUPABASE_URL = "https://vnwtjqltrabvawtpeudv.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZud3RqcWx0cmFidmF3dHBldWR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3OTkzNTQsImV4cCI6MjA3NzM3NTM1NH0.qN6-icK-6HzHvoPy5NPrbVJ1LKMBDAn9p9zE8l1kkhE";

      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const statusEl = document.getElementById("status");
      const formEl = document.getElementById("password-form");
      const passwordInput = document.getElementById("password");

      // 游댳 1) Intercambiar el code por una sesi칩n
      async function init() {
        try {
          const url = new URL(window.location.href);
          const code = url.searchParams.get("code");

          if (!code) {
            statusEl.textContent =
              "No se encontr칩 el c칩digo de recuperaci칩n en la URL.";
            return;
          }

          // Muy importante: esto crea la sesi칩n a partir del code
          const { data, error } = await client.auth.exchangeCodeForSession(code);

          if (error) {
            console.error(error);
            statusEl.textContent =
              "No se pudo verificar el enlace: " + error.message;
            return;
          }

          // Si llega aqu칤, ya hay sesi칩n y se puede cambiar la contrase침a
          statusEl.textContent =
            "C칩digo verificado. Ingresa tu nueva contrase침a.";
          formEl.style.display = "block";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error inesperado al verificar el enlace.";
        }
      }

      init();

      // 游댳 2) Enviar nueva contrase침a
      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();
        const newPassword = passwordInput.value;

        statusEl.textContent = "Actualizando contrase침a...";

        const { data, error } = await client.auth.updateUser({
          password: newPassword,
        });

        if (error) {
          console.error(error);
          statusEl.textContent = "Error al actualizar: " + error.message;
          return;
        }

        statusEl.textContent =
          "Contrase침a actualizada correctamente. Ya puedes volver a la app.";
        formEl.style.display = "none";
      });
    </script>
  </body>
</html>

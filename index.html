<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Cambiar contrase√±a</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        max-width: 480px;
        margin: 40px auto;
        padding: 16px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
      }
      input {
        width: 100%;
        padding: 8px;
        margin-bottom: 16px;
      }
      button {
        padding: 10px 16px;
        cursor: pointer;
      }
      #status {
        margin-bottom: 12px;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Cambiar contrase√±a</h1>
      <p id="status">Verificando enlace...</p>

      <form id="password-form" style="display:none;">
        <label for="password">Nueva contrase√±a</label>
        <input type="password" id="password" minlength="6" required />

        <button type="submit">Guardar contrase√±a</button>
      </form>
    </div>

    <!-- Supabase JS v2 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      const { createClient } = supabase;

      // üëá RELLENA ESTO CON LOS DATOS DE TU PROYECTO
      const SUPABASE_URL = "https://vnwtjqltrabvawtpeudv.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZud3RqcWx0cmFidmF3dHBldWR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3OTkzNTQsImV4cCI6MjA3NzM3NTM1NH0.qN6-icK-6HzHvoPy5NPrbVJ1LKMBDAn9p9zE8l1kkhE";

      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const statusEl = document.getElementById("status");
      const formEl = document.getElementById("password-form");
      const passwordInput = document.getElementById("password");

      async function init() {
        const url = new URL(window.location.href);
        const code = url.searchParams.get("code");

        console.log("URL actual:", url.toString());
        console.log("code:", code);

        if (!code) {
          statusEl.textContent =
            "No se encontr√≥ el c√≥digo de recuperaci√≥n en la URL.";
          return;
        }

        // 1) Intercambiar el code por una sesi√≥n
        const { data, error } = await client.auth.exchangeCodeForSession(code);

        console.log("exchangeCodeForSession:", data, error);

        if (error) {
          statusEl.textContent =
            "No se pudo verificar el enlace: " + error.message;
          return;
        }

        // 2) Si llegamos aqu√≠, YA hay sesi√≥n ‚Üí mostramos formulario
        statusEl.textContent =
          "C√≥digo verificado. Ingresa tu nueva contrase√±a.";
        formEl.style.display = "block";
      }

      init();

      // 3) Enviar nueva contrase√±a
      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();
        const newPassword = passwordInput.value;

        statusEl.textContent = "Actualizando contrase√±a...";

        const { data, error } = await client.auth.updateUser({
          password: newPassword,
        });

        if (error) {
          console.error(error);
          statusEl.textContent = "Error al actualizar: " + error.message;
          return;
        }

        statusEl.textContent =
          "Contrase√±a actualizada correctamente. Ya puedes volver a la app.";
        formEl.style.display = "none";
      });
    </script>
  </body>
</html>
